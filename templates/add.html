{% extends "base.html" %}
{% block title %}Add Recipe{% endblock %}

{% block content %}
<main class="homepage">

  <!-- === Add Recipe Card === -->
  <div class="recipe-edit"
       style="max-width:900px;margin:auto;background:#fff;border-radius:10px;
              padding:1.5rem;box-shadow:0 2px 6px rgba(0,0,0,0.1);">

    <h2 style="margin-top:0;color:#1a2c5b;text-align:center;">‚ûï Add New Recipe</h2>

    <!-- === Form === -->
    <form id="addForm" method="post" action="{{ url_for('add_recipe') }}"
          style="display:flex;flex-direction:column;gap:1rem;">

      <!-- === Compact Info Grid === -->
<div class="info-grid"
     style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
            gap:1rem;align-items:start;">
  <div>
    <label><strong>Name</strong></label>
    <input name="name" required placeholder="e.g. Tagliatelle Carbonara"
           style="width:100%;padding:0.5rem;border:1px solid #bbb;border-radius:6px;">
  </div>
  <div>
    <label><strong>Recipe Link</strong></label>
    <input type="text" name="linked_recipe" placeholder="https://example.com"
           style="width:100%;padding:0.5rem;border:1px solid #bbb;border-radius:6px;">
  </div>

  <!-- === Image URL + Inline Preview === -->
  <div style="display:flex;align-items:flex-start;gap:0.6rem;flex-wrap:nowrap;">
    <div style="flex:1;">
      <label><strong>Image URL</strong></label>
      <input type="text" name="image_url" id="imageURL"
             placeholder="https://example.com/photo.jpg"
             style="width:100%;padding:0.5rem;border:1px solid #bbb;border-radius:6px;">
    </div>
    <div id="imagePreview"
     style="flex:0 0 100px; text-align:center; margin-left:2rem;">
  <div class="preview-box"
       style="width:100px; height:100px; background:#f0f0f0; border-radius:6px;
              display:flex; align-items:center; justify-content:center;
              color:#aaa; font-size:0.8rem;">
    No image
  </div>
</div>

  </div>
</div>

<style>
/* Hide preview entirely on narrow screens */
@media (max-width: 700px) {
  #imagePreview { display:none !important; }
}
</style>

      <!-- === Ingredients === -->
      <label><strong>Ingredients (one per line)</strong></label>
      <textarea name="ingredients" rows="5"
                placeholder="200 g penne\n2 cloves garlic\n1 cup milk"
                style="width:100%;border:1px solid #bbb;border-radius:6px;
                       padding:0.6rem;resize:vertical;min-height:100px;"></textarea>

      <!-- === Method === -->
      <label><strong>Method</strong></label>
      <textarea name="method" rows="6"
                placeholder="Step-by-step instructions..."
                style="width:100%;border:1px solid #bbb;border-radius:6px;
                       padding:0.6rem;resize:vertical;min-height:120px;"></textarea>

      <!-- === Tags (unchanged) === -->
      <h3 style="margin-top:1rem;">Tags</h3>
      {% if tags_dict %}
        <div class="tag-groups" style="display:flex;flex-wrap:wrap;gap:1rem;">
          {% for group_name, tag_list in tags_dict.items() %}
            <fieldset style="border:1px solid #ddd;border-radius:8px;
                             padding:0.8rem;min-width:200px;flex:1;">
              <legend style="font-weight:600;">{{ group_name }}</legend>
              <div style="display:flex;flex-wrap:wrap;gap:0.4rem;">
                {% for t in tag_list %}
                  <label style="cursor:pointer;">
                    <input type="checkbox" name="tags" value="{{ t }}" style="display:none;">
                    <span class="tag-pill" style="
                          display:inline-block;padding:0.35rem 0.8rem;
                          border-radius:16px;border:1px solid #0a8274;
                          color:#0a8274;background:#fff;font-size:0.85rem;
                          transition:all 0.2s ease;">{{ t }}</span>
                  </label>
                {% endfor %}
              </div>
            </fieldset>
          {% endfor %}
        </div>
      {% else %}
        <p style="color:#777;">No tags defined yet. Use ‚ÄúManage Tags‚Äù to create groups.</p>
      {% endif %}

      <p style="margin-top:1rem;">
        <strong>Extra tags (comma-separated):</strong><br>
        <input type="text" name="extra_tags" placeholder="e.g. spicy, family-favourite"
               style="width:100%;border:1px solid #bbb;border-radius:6px;padding:0.6rem;">
      </p>
    </form>
  </div>

  <!-- === Scripts === -->
<script>
  // --- Live image preview ---
  const imageInput = document.querySelector('input[name="image_url"]');
  const imagePreview = document.getElementById('imagePreview');
  if (imageInput && imagePreview) {
    imageInput.addEventListener('input', () => {
      const url = imageInput.value.trim();
      if (url) {
        imagePreview.innerHTML =
          `<img src="${url}" alt="Preview"
                style="max-width:180px;border-radius:6px;">`;
      } else {
        imagePreview.innerHTML =
          `<div style="width:100%;max-width:180px;height:100px;margin:auto;
                       background:#f0f0f0;border-radius:6px;display:flex;
                       align-items:center;justify-content:center;color:#aaa;">
             No image
           </div>`;
      }
    });
  }

  // --- Tag pill toggle (unchanged) ---
  document.querySelectorAll('.tag-groups label').forEach(label => {
    const checkbox = label.querySelector('input[type="checkbox"]');
    const pill = label.querySelector('.tag-pill');
    label.addEventListener('click', e => {
      e.preventDefault();
      checkbox.checked = !checkbox.checked;
      pill.style.background = checkbox.checked ? '#0a8274' : '#fff';
      pill.style.color = checkbox.checked ? '#fff' : '#0a8274';
    });
  });

  // --- Add Save + Cancel into global control space ---
  window.addEventListener("load", () => {
    const formEl = document.getElementById("addForm");
    const cs = document.getElementById("control-space");
    const clearBtn = document.getElementById("clearSelectedBtn");

    console.log("form:", !!formEl, "control-space:", !!cs);

    if (!formEl || !cs || !clearBtn) return;

    // Cancel button
    if (!document.getElementById("cancelBtn")) {
      const cancelBtn = document.createElement("a");
      cancelBtn.id = "cancelBtn";
      cancelBtn.href = "/";
      cancelBtn.textContent = "‚úñ Cancel";
      cancelBtn.className = "btn-danger";
      cancelBtn.style.padding = "0.6rem 1.2rem";
      cancelBtn.style.borderRadius = "8px";
      cancelBtn.style.fontWeight = "600";
      cancelBtn.style.textDecoration = "none";
      cs.insertBefore(cancelBtn, clearBtn);
    }

    // Save button
    if (!document.getElementById("saveBtn")) {
      const saveBtn = document.createElement("button");
      saveBtn.id = "saveBtn";
      saveBtn.textContent = "üíæ Save";
      saveBtn.className = "btn-edit";
      saveBtn.type = "submit";
      saveBtn.style.padding = "0.6rem 1.2rem";
      saveBtn.style.borderRadius = "8px";
      saveBtn.style.fontWeight = "600";
      saveBtn.style.cursor = "pointer";

      cs.insertBefore(saveBtn, clearBtn);
      saveBtn.setAttribute("form", "addForm"); // safer, works in all browsers

      console.log("Form linked via setAttribute:", saveBtn.getAttribute("form"));
    }
  });
  
</script>

</main>
{% endblock %}
